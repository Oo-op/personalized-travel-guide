<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个性化旅游系统</title>
    <link rel="stylesheet" href="/public/1.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 标签基础样式 */
        .tag {
            padding: 0.5rem 1rem;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            user-select: none;
        }

        .tag:hover {
            background: #e0e0e0;
        }

        .tag.selected {
            background: #27aeb0 !important;
            color: white !important;
            border-color: #27aeb0 !important;
        }

        /* 标签容器样式 */
        .tags-container, .journal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="logo">TRAVEL</div>
            <ul class="nav-links">
                <li><a href="#">首页</a></li>
                <li><a href="#searching">规划与查找</a></li>
                <li><a href="#finding">推荐</a></li>
                <li><a href="#writing">写日志</a></li>
                <li><a href="/public/travel-journal.html">旅游日记</a></li>
            </ul>
            <button id="logoutBtn" class="logout-button">
                <i class="fas fa-sign-out-alt"></i> 登出
            </button>
        </nav>
        <div class="hero">
            <h1>个性化旅游系统</h1>
            <p>Personalized tourism system</p>
        </div>
    </header>
    
    <main>
     <section class="recommendation-section" id="finding">
    <div class="section-title">
        <h2>===推荐===</h2>
    </div>
    
    <div class="form-group">
        <!-- 搜索框 -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="输入景点名称、类别或关键字...">
            <button id="searchButton"><i class="fas fa-search"></i> 搜索</button>
        </div>
        
        <!-- 移除了筛选方式按钮 -->
        
        <label>兴趣标签</label>
        <div class="tags-container">
            <div class="tag" data-tag="历史景点">历史景点</div>
            <div class="tag" data-tag="公园">公园</div>
            
            <div class="tag" data-tag="人文景点">人文景点</div>
            <div class="tag" data-tag="自然景区">自然景区</div>
          
        </div>
    </div>
    
    <div class="recommendations">
        <form class="popular-attractions-form">
            <h3 class="popular-title">
                <i class="fas fa-fire"></i>
                <span id="recommend-title">景点推荐</span>
                <span class="badge" id="filter-badge">全部</span>
            </h3>
            
            <!-- 排序选项（仅在搜索结果时显示） -->
            <div class="sort-options" id="sortOptions">
                <span>排序方式：</span>
                <select id="sortSelect">
                    <option value="default">默认排序</option>
                    <option value="fire-desc">热度从高到低</option>
                    <option value="fire-asc">热度从低到高</option>
                    <option value="score-desc">评分从高到低</option>
                    <option value="score-asc">评分从低到高</option>
                </select>
            </div>
            
            <div class="attractions-grid" id="attractions-container">
                <!-- 动态加载的景点将显示在这里 -->
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-primary" id="planButton">
                    <i class="fas fa-plane"></i>
                    生成定制路线
                </button>
            </div>
        </form>
    </div>
</section>

<section class="preference-section" id="searching">
            <div class="section-title">
                <h2>探索不停步，天天新体验</h2>
            </div>

            <form class="preference-form" id="destinationForm">
                <div class="form-group">
                    <label for="destinationName">目的地名称</label>
                    <input type="text" 
                        id="destinationName" 
                        class="form-control" 
                        placeholder="请输入地点名称"
                        required>
                </div>
                    <button type="button" class="btn btn-go" id="goButton">前往</button>
                </form> 
                <script>
                    // "前往"按钮的点击事件，跳转到场所查询
                    document.getElementById('goButton').addEventListener('click', function() {
    const destinationName = document.getElementById('destinationName').value.trim();
    
    if (!destinationName) {
        alert('请输入目的地名称');
        return;
    }
    
    // 验证输入只能是"北邮"或"北海"
    if (destinationName !== '北邮' && destinationName !== '北海') {
        alert('请输入有效的目的地名称（只能是"北邮"或"北海"）');
        return;
    }
    
    // 跳转到场所查询页面，传递目的地名称参数
    window.location.href = `/public/placeSearch.html?destinationName=${encodeURIComponent(destinationName)}`;
});
                </script>
            </form>
        </section>

<style>
/* 新增样式 */
.search-box {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
}

.search-box input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.search-box button {
    padding: 8px 15px;
    background-color: #1890ff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.sort-options {
    margin: 10px 0;
    padding: 8px 0;
}

.sort-options select {
    padding: 5px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.top10-badge {
    display: none; 
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #ff4d4f;
    color: white;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
}

.attraction-card.top10 {
    display: none; 
    border: 2px solid #1890ff;
    position: relative;
}
</style>

<script>
// 全局变量
let selectedTag = '';
let isSearching = false;
let currentSearchResults = [];

// 朴素字符串匹配算法实现搜索
function naiveStringSearch(text, pattern) {
    if (!text || !pattern) return false;
    const n = text.length;
    const m = pattern.length;
    
    for (let i = 0; i <= n - m; i++) {
        let j;
        for (j = 0; j < m; j++) {
            if (text[i + j].toLowerCase() !== pattern[j].toLowerCase()) {
                break;
            }
        }
        if (j === m) {
            return true;
        }
    }
    return false;
}

// 初始化页面
document.addEventListener('DOMContentLoaded', () => {
    loadAttractions();
    
    // 标签点击
    document.querySelectorAll('.tags-container .tag').forEach(tag => {
        tag.addEventListener('click', function() {
            document.querySelectorAll('.tags-container .tag').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');
            selectedTag = this.dataset.tag;
            loadAttractions();
        });
    });
    
    // 搜索按钮
    document.getElementById('searchButton').addEventListener('click', performSearch);
    
    // 搜索输入框回车事件
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });
    
    // 排序选择
    document.getElementById('sortSelect').addEventListener('change', sortSearchResults);
    
    // 生成路线按钮
    document.getElementById('planButton').addEventListener('click', function() {
        const selectedAttraction = document.querySelector('.attraction-checkbox:checked');
        if (!selectedAttraction) {
            alert('请选择一个景点');
            return;
        }
        sessionStorage.setItem('selectedAttraction', selectedAttraction.value);
        sendSelectedAttractionToBackend(selectedAttraction.value);
    });
});

// 执行搜索
async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    const container = document.getElementById('attractions-container');
    
    if (!query) {
        isSearching = false;
        loadAttractions();
        return;
    }

    container.innerHTML = '<div class="loading">搜索中...</div>';
    
    try {
        // 先获取所有景点数据
        const response = await fetch('/api/spot');
        if (!response.ok) throw new Error(`请求失败: ${response.status}`);
        const allAttractions = await response.json();
        
        // 使用朴素字符串匹配算法进行搜索
        const searchResults = [];
        for (const attraction of allAttractions) {
            // 在景点名称中搜索
            if (naiveStringSearch(attraction.name || '', query)) {
                searchResults.push(attraction);
                continue;
            }
            
            // 在景点地址中搜索
            if (naiveStringSearch(attraction.address || '', query)) {
                searchResults.push(attraction);
                continue;
            }
            
            // 在标签中搜索
            if (attraction.tag) {
                const tags = attraction.tag.split(',');
                for (const tag of tags) {
                    if (naiveStringSearch(tag.trim(), query)) {
                        searchResults.push(attraction);
                        break;
                    }
                }
            }
        }
        
        // 处理搜索结果
        currentSearchResults = searchResults;
        isSearching = true;
        
        document.getElementById('recommend-title').textContent = `搜索 "${query}" 的结果`;
        document.getElementById('filter-badge').textContent = '搜索';
        
        // 显示搜索结果
        if (searchResults.length === 0) {
            container.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-info-circle"></i>
                    <p>没有找到匹配的结果</p>
                    <ul>
                        <li>检查输入是否有拼写错误</li>
                        <li>尝试更简单的关键词</li>
                    </ul>
                </div>
            `;
        } else {
            sortSearchResults();
        }
    } catch (error) {
        console.error('搜索失败:', error);
        container.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>搜索失败: ${error.message}</span>
            </div>
        `;
        document.getElementById('recommend-title').textContent = '搜索失败';
        document.getElementById('filter-badge').textContent = '错误';
    }
}

async function loadAttractions() {
    try {
        let url = '/api/spot';
        const params = [];
        
        if (selectedTag) {
            url += '?tag=' + encodeURIComponent(selectedTag);
        }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`请求失败: ${response.status}`);
        
        const attractions = await response.json();
        renderAttractions(attractions, false);
        
        isSearching = false;
        document.getElementById('recommend-title').textContent = '景点推荐';
        document.getElementById('filter-badge').textContent = '全部';
        
        // 默认排序
        sortSearchResults();
    } catch (error) {
        console.error('加载景点数据失败:', error);
        alert(`加载失败: ${error.message}`);
    }
}

// 使用选择排序法
function sortSearchResults() {
    try {
        if (!currentSearchResults || !Array.isArray(currentSearchResults)) {
            throw new Error('无有效搜索结果');
        }
        const sortValue = document.getElementById('sortSelect').value;

        if (isSearching) {
            // 处理搜索结果排序 - 使用选择排序
            let sortedResults = [...currentSearchResults];
            
            // 选择排序实现
            for (let i = 0; i < sortedResults.length - 1; i++) {
                let minOrMaxIndex = i;
                
                for (let j = i + 1; j < sortedResults.length; j++) {
                    let shouldSwap = false;
                    const a = sortedResults[j];
                    const b = sortedResults[minOrMaxIndex];
                    
                    switch(sortValue) {
                        case 'fire-desc':
                            shouldSwap = (a.fire || 0) > (b.fire || 0);
                            break;
                        case 'fire-asc':
                            shouldSwap = (a.fire || 0) < (b.fire || 0);
                            break;
                        case 'score-desc':
                            shouldSwap = (a.score || 0) > (b.score || 0);
                            break;
                        case 'score-asc':
                            shouldSwap = (a.score || 0) < (b.score || 0);
                            break;
                        default:
                            shouldSwap = false;
                    }
                    
                    if (shouldSwap) {
                        minOrMaxIndex = j;
                    }
                }
                
                if (minOrMaxIndex !== i) {
                    [sortedResults[i], sortedResults[minOrMaxIndex]] = 
                    [sortedResults[minOrMaxIndex], sortedResults[i]];
                }
            }
            
            renderAttractions(sortedResults, true);
        } else {
            // 处理普通列表排序 - 使用选择排序
            const container = document.getElementById('attractions-container');
            const cards = Array.from(container.querySelectorAll('.attraction-card'));
            
            for (let i = 0; i < cards.length - 1; i++) {
                let minOrMaxIndex = i;
                
                for (let j = i + 1; j < cards.length; j++) {
                    let shouldSwap = false;
                    const aScore = parseFloat(cards[j].querySelector('.rating span:nth-child(2)').textContent) || 0;
                    const bScore = parseFloat(cards[minOrMaxIndex].querySelector('.rating span:nth-child(2)').textContent) || 0;
                    const aFire = parseInt(cards[j].querySelector('.review-count').textContent.match(/\d+/)[0]) || 0;
                    const bFire = parseInt(cards[minOrMaxIndex].querySelector('.review-count').textContent.match(/\d+/)[0]) || 0;
                    
                    switch(sortValue) {
                        case 'fire-desc':
                            shouldSwap = aFire > bFire;
                            break;
                        case 'fire-asc':
                            shouldSwap = aFire < bFire;
                            break;
                        case 'score-desc':
                            shouldSwap = aScore > bScore;
                            break;
                        case 'score-asc':
                            shouldSwap = aScore < bScore;
                            break;
                        default:
                            shouldSwap = false;
                    }
                    
                    if (shouldSwap) {
                        minOrMaxIndex = j;
                    }
                }
                
                if (minOrMaxIndex !== i) {
                    container.insertBefore(cards[minOrMaxIndex], cards[i]);
                    [cards[i], cards[minOrMaxIndex]] = [cards[minOrMaxIndex], cards[i]];
                }
            }
        }
    } catch (error) {
        console.error(error.message);
    }
}

// 渲染景点列表
function renderAttractions(attractions, isSearchResult) {
    const container = document.getElementById('attractions-container');
    container.innerHTML = '';

    if (attractions.length === 0) {
        container.innerHTML = '<p class="no-results">没有找到符合条件的景点</p>';
        return;
    }

    const selectedAttraction = sessionStorage.getItem('selectedAttraction');
       
    attractions.forEach((attraction, index) => {
        const card = document.createElement('div');
        card.className = `attraction-card ${index < 10 && !isSearchResult ? 'top10' : ''}`;

        // 星级评分
        const score = attraction.score || 0;
        const fullStars = Math.floor(score);
        const hasHalfStar = score % 1 >= 0.5;
        let starsHtml = '';

        for (let i = 0; i < 5; i++) {
            if (i < fullStars) {
                starsHtml += '★';
            } else if (i === fullStars && hasHalfStar) {
                starsHtml += '☆';
            } else {
                starsHtml += '☆';
            }
        }

        // 标签
        const tagValue = attraction.tag || '';
        const tagsHtml = tagValue.split(',').map(tag => 
            tag.trim() ? `<span class="tag">${tag.trim()}</span>` : ''
        ).join('');

        // 卡片内容
        card.innerHTML = `
            ${index < 10 && !isSearchResult ? '<span class="top10-badge">TOP10</span>' : ''}
            <input type="radio" id="attraction-${index}" name="attractions" 
                   value="${attraction.name}" class="attraction-checkbox"
                   data-name="${attraction.name}" ${selectedAttraction === attraction.name ? 'checked' : ''}> 
            <label for="attraction-${index}" class="attraction-label">
                <div class="attraction-content">
                    <h4>${attraction.name || '未命名景点'}</h4>
                    <div class="rating">
                        <span class="stars">${starsHtml}</span>
                        <span>${score.toFixed(1)}分</span>
                        <span class="review-count">(${attraction.fire || 0}热度)</span>
                    </div>
                    <p>${attraction.address || '暂无地址信息'}</p>
                    <div class="tags">${tagsHtml}</div>
                </div>
            </label>
        `;

        container.appendChild(card);

        const radio = card.querySelector('.attraction-checkbox');
        radio.addEventListener('change', async function() {
            if (this.checked) {
                const spotName = this.value;
                console.log('尝试更新热度:', spotName);
                
                try {
                    sessionStorage.setItem('selectedAttraction', spotName);
                    const response = await fetch(`/api/spot/${encodeURIComponent(spotName)}/fire`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '请求失败');
                    }
                    
                    const result = await response.json();
                    console.log('热度更新成功:', result);
                    
                    const fireElement = this.closest('.attraction-card').querySelector('.review-count');
                    if (fireElement && result.newFireCount !== undefined) {
                        fireElement.textContent = `(${result.newFireCount}热度)`;
                    }
                } catch (error) {
                    console.error('更新热度失败:', {
                        spot: spotName,
                        error: error.message
                    });
                }
            }
        });
    });
}

// 发送选中的景点到后端API
async function sendSelectedAttractionToBackend(attraction) {
    try {
        const response = await fetch('/api/temporal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ attraction: attraction }),
        });
 
        if (!response.ok) throw new Error(`请求失败: ${response.status}`);
        
        const result = await response.json();
        console.log('保存成功:', result);
        window.location.href = '/public/routePlan.html';
    } catch (error) {
        console.error('保存失败:', error);
        alert(`保存失败: ${error.message}`);
    }
}
</script>

<!----------------------------------以下为日志部分-------------------------------->>
        
        <section class="simple-journal-section" id="writing">
            <div class="section-title">
                <h2>旅行日志</h2>
                <p>记录你的旅程，分享你的故事</p>
            </div>
            
            <div class="journal-layout">
                <!-- 日志撰写区 -->
                <div class="journal-write" id="journalWriteSection">
                    <div class="write-header">
                        <h3><i class="fas fa-pen"></i> 写日志</h3>
                        <!-- <button class="close-write" id="closeWriteBtn">&times;</button>  -->
                    </div>
                    <form id="simple-journal-form">
                        <div class="form-group">
                            <label for="journalTitle">标题</label>
                            <input type="text" id="journalTitle" class="form-control" placeholder="为您的日记起个标题" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="journalDestination">目的地</label>
                            <input type="text" id="journalDestination" class="form-control" placeholder="您去了哪里？">
                        </div>
                        
                        <div class="form-group">
                            <label>选择标签</label>
                            <div class="tags-container journal-tags">
                                <div class="tag" data-tag="历史景点">历史景点</div>
                                <div class="tag" data-tag="公园">公园</div>
                                
                                <div class="tag" data-tag="人文景点">人文景点</div>
                                <div class="tag" data-tag="自然景区">自然景区</div>
                               
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="journalContent">内容</label>
                            <textarea id="journalContent" rows="10" placeholder="写下您的旅游经历..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>上传照片或视频</label>
                            <div class="image-upload">
                                <input type="file" id="journalImages" accept="image/*,video/*" multiple>
                                <label for="journalImages" class="upload-button">
                                    <i class="fas fa-camera"></i> 选择照片或视频
                                </label>
                                <div class="image-preview" id="imagePreview"></div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="cancel-button" id="cancelJournalBtn">取消</button>
                            <button type="submit" class="save-button">发布</button>
                        </div>
                    </form>
                </div>
                
                <!-- 日志浏览区 -->
                <div class="journal-read">
                    <h3><i class="fas fa-book"></i> 大家的旅行日志</h3>
                    <div class="journal-entries" id="simple-journal-entries">
                        <!-- 日志条目将通过JavaScript动态加载 -->
                    </div>
                    
                    <!-- 查看所有日志链接 -->
                    <div class="view-all-journals">
                        <a href="/public/travel-journal.html" class="view-all-link">查看完整日志 &raquo;</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // 添加登出功能
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/public/index.html';
                }
            } catch (error) {
                console.error('登出错误:', error);
            }
        });

        // 加载日志列表
        async function loadJournals() {
            try {
                const response = await fetch('/api/journals');
                const data = await response.json();
                
                if (data.success) {
                    const journalEntries = document.getElementById('simple-journal-entries');
                    
                    if (data.journals.length === 0) {
                        journalEntries.innerHTML = `
                            <div class="empty-message">
                                <p>还没有旅游日记，快来发布第一篇吧！</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // 只显示最新的3篇日记
                    const recentJournals = data.journals.slice(0, 3);
                    
                    journalEntries.innerHTML = recentJournals.map(journal => `
                        <div class="journal-entry">
                            <h4 class="entry-title">${journal.title}</h4>
                            <p class="entry-content">${journal.content.substring(0, 100)}...</p>
                            <div class="entry-meta">
                                <span class="entry-author">${journal.author}</span>
                                <span class="entry-date">${new Date(journal.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    console.error('加载日记失败');
                }
            } catch (error) {
                console.error('加载日记错误:', error);
            }
        }

        // 关闭写日志区域
        // document.getElementById('closeWriteBtn').addEventListener('click', function() {
        //     window.location.href = "#writing"; // 返回日志部分
        // });
        
        // 取消按钮
        document.getElementById('cancelJournalBtn').addEventListener('click', function() {
            document.getElementById('journalTitle').value = '';
            document.getElementById('journalContent').value = '';
            document.getElementById('journalDestination').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            window.location.href = "#writing"; // 返回日志部分
        });
        
        // 表单提交
        document.getElementById('simple-journal-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('journalTitle').value;
            const content = document.getElementById('journalContent').value;
            const destination = document.getElementById('journalDestination').value;
            const imageFiles = document.getElementById('journalImages').files;
            
            // 获取选中的标签
            const selectedTag = document.querySelector('.journal-tags .tag.selected')?.dataset.tag || '';
            
            if (!title || !content) {
                alert('请填写标题和内容！');
                return;
            }
            
            try {
                // 获取当前登录用户ID
                const response = await fetch('/api/check-auth');
                const authData = await response.json();
                
                if (!authData.isLoggedIn) {
                    alert('请先登录！');
                    return;
                }
                
                // 1. 先发布日记
                const publishResponse = await fetch('/api/journals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        destination,
                        tag: selectedTag,
                        id: authData.user.id
                    })
                });
                
                const data = await publishResponse.json();
                
                if (data.success) {
                    // 2. 如果有图片，上传图片
                    if (imageFiles.length > 0) {
                        const formData = new FormData();
                        for (let file of imageFiles) {
                            formData.append('images', file);
                        }
                        
                        const imageResponse = await fetch(`/api/journals/${data.journalId}/images`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const imageData = await imageResponse.json();
                        if (!imageData.success) {
                            console.error('图片上传失败:', imageData.message);
                        }
                    }
                    
                    alert('日记发布成功！');
                    this.reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    // 重新加载日志列表
                    loadJournals();
                } else {
                    alert(data.message || '发布失败');
                }
            } catch (error) {
                console.error('发布日记错误:', error);
                alert('发布失败');
            }
        });

        // 兴趣标签多选带限制功能
        document.addEventListener('DOMContentLoaded', function() {
            // 写日志部分的标签
            const journalTags = document.querySelectorAll('.journal-tags .tag');
            let selectedTag = null;

            journalTags.forEach(tag => {
                tag.addEventListener('click', async function() {
                    // 如果点击的是当前选中的标签，则取消选中
                    if(this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedTag = null;
                    } else {
                        // 先移除其他标签的选中状态
                        document.querySelectorAll('.journal-tags .tag').forEach(t => {
                            t.classList.remove('selected');
                        });
                        // 选中当前标签
                        this.classList.add('selected');
                        selectedTag = this.dataset.tag;

                        // 更新用户兴趣统计
                        try {
                            const response = await fetch('/api/check-auth');
                            const authData = await response.json();
                            
                            if (authData.isLoggedIn) {
                                await fetch('/api/update-interest', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        id: authData.user.id,
                                        tag: selectedTag
                                    })
                                });
                            }
                        } catch (error) {
                            console.error('更新兴趣统计失败:', error);
                        }
                    }
                    console.log('当前选中的标签:', selectedTag);
                });
            });

            // 推荐部分的标签
            const filterTags = document.querySelectorAll('.tags-container .tag');
            filterTags.forEach(tag => {
                tag.addEventListener('click', async function() {
                    document.querySelectorAll('.tags-container .tag').forEach(t => {
                        t.classList.remove('selected');
                    });
                    this.classList.add('selected');

                    // 更新用户兴趣统计
                    try {
                        const response = await fetch('/api/check-auth');
                        const authData = await response.json();
                        
                        if (authData.isLoggedIn) {
                            await fetch('/api/update-interest', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    id: authData.user.id,
                                    tag: this.dataset.tag
                                })
                            });
                        }
                    } catch (error) {
                        console.error('更新兴趣统计失败:', error);
                    }
                });
            });

            // 页面加载时获取日志列表
            loadJournals();
        });

        // 图片预览功能
        document.getElementById('journalImages').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (file.type.match('image.*')) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.style.marginRight = '5px';
                        img.style.borderRadius = '4px';
                        preview.appendChild(img);
                    } else if (file.type.match('video.*')) {
                        // 创建视频元素
                        const video = document.createElement('video');
                        video.src = e.target.result;
                        video.style.display = 'none';
                        preview.appendChild(video);

                        // 当视频元数据加载完成后获取第一帧
                        video.onloadedmetadata = function() {
                            video.currentTime = 0;
                        };

                        video.onseeked = function() {
                            // 创建canvas来捕获视频帧
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // 创建预览图片
                            const thumbnail = document.createElement('img');
                            thumbnail.src = canvas.toDataURL();
                            thumbnail.style.width = '80px';
                            thumbnail.style.height = '80px';
                            thumbnail.style.objectFit = 'cover';
                            thumbnail.style.marginRight = '5px';
                            thumbnail.style.borderRadius = '4px';
                            thumbnail.style.position = 'relative';
                            
                            // 添加视频标识
                            const videoIcon = document.createElement('i');
                            videoIcon.className = 'fas fa-video';
                            videoIcon.style.position = 'absolute';
                            videoIcon.style.top = '5px';
                            videoIcon.style.right = '5px';
                            videoIcon.style.color = 'white';
                            videoIcon.style.backgroundColor = 'rgba(0,0,0,0.5)';
                            videoIcon.style.padding = '2px';
                            videoIcon.style.borderRadius = '3px';
                            
                            const container = document.createElement('div');
                            container.style.position = 'relative';
                            container.style.display = 'inline-block';
                            container.appendChild(thumbnail);
                            container.appendChild(videoIcon);
                            
                            preview.appendChild(container);
                            
                            // 移除视频元素
                            video.remove();
                        };
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>